#!/usr/bin/env python3
"""CVE-2012-1823 safe detector (no RCE payloads).

This script performs a read-only check for signs that PHP-CGI command-line
flags may be accepted via query string (legacy CVE-2012-1823 behavior).
It does NOT attempt command execution.
"""

from __future__ import annotations

import argparse
import json
import sys
from dataclasses import dataclass
from urllib.error import HTTPError, URLError
from urllib.parse import urlsplit, urlunsplit
from urllib.request import Request, urlopen


@dataclass
class ProbeResponse:
    url: str
    status: int | None
    body: str
    error: str | None = None


def _fetch(url: str, timeout: float) -> ProbeResponse:
    request = Request(url, headers={"User-Agent": "cve-2012-1823-safe-check/1.0"})
    try:
        with urlopen(request, timeout=timeout) as resp:  # nosec B310
            charset = resp.headers.get_content_charset() or "utf-8"
            body = resp.read(100_000).decode(charset, errors="replace")
            return ProbeResponse(url=url, status=resp.getcode(), body=body)
    except HTTPError as exc:
        data = exc.read(100_000).decode("utf-8", errors="replace") if exc.fp else ""
        return ProbeResponse(url=url, status=exc.code, body=data, error=str(exc))
    except URLError as exc:
        return ProbeResponse(url=url, status=None, body="", error=str(exc))


def _with_probe_suffix(base_url: str, suffix: str) -> str:
    parts = urlsplit(base_url)
    path = parts.path or "/"
    if not path.endswith(".php"):
        path = path.rstrip("/") + "/index.php"

    # CVE-2012-1823 checks rely on query-string flag handling in vulnerable PHP-CGI.
    query = suffix if not parts.query else f"{parts.query}&{suffix}"
    return urlunsplit((parts.scheme, parts.netloc, path, query, parts.fragment))


def _looks_like_source_disclosure(text: str) -> bool:
    lowered = text.lower()
    markers = [
        "<code><span style=",
        "&lt;?php",
        "phpmyadmin",
    ]
    return all(marker in lowered for marker in markers[:2]) and markers[2] in lowered


def _looks_like_php_cli_help(text: str) -> bool:
    lowered = text.lower()
    return "usage:" in lowered and "php" in lowered and "options:" in lowered


def run_check(target_url: str, timeout: float) -> dict[str, object]:
    baseline = _fetch(target_url, timeout)
    probe_source = _fetch(_with_probe_suffix(target_url, "-s"), timeout)
    probe_help = _fetch(_with_probe_suffix(target_url, "-h"), timeout)

    source_hit = probe_source.status == 200 and _looks_like_source_disclosure(probe_source.body)
    help_hit = probe_help.status == 200 and _looks_like_php_cli_help(probe_help.body)

    likely_vulnerable = bool(source_hit or help_hit)

    return {
        "target": target_url,
        "likely_vulnerable": likely_vulnerable,
        "signals": {
            "source_disclosure_via_-s": source_hit,
            "php_cli_help_via_-h": help_hit,
        },
        "responses": {
            "baseline_status": baseline.status,
            "probe_s_status": probe_source.status,
            "probe_h_status": probe_help.status,
            "baseline_error": baseline.error,
            "probe_s_error": probe_source.error,
            "probe_h_error": probe_help.error,
        },
        "notes": [
            "Detection-only check. No command execution attempted.",
            "False positives/negatives are possible; confirm manually.",
            "If exposed, patch PHP and disable vulnerable CGI execution paths.",
        ],
    }


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(description="Safe CVE-2012-1823 exposure check")
    parser.add_argument("url", help="Target URL, e.g. http://host/phpMyAdmin/setup/index.php")
    parser.add_argument("--timeout", type=float, default=10.0, help="Request timeout in seconds")
    return parser.parse_args()


def main() -> int:
    args = parse_args()
    result = run_check(args.url, args.timeout)
    print(json.dumps(result, indent=2))
    return 1 if result["likely_vulnerable"] else 0


if __name__ == "__main__":
    sys.exit(main())
