"""Main exploitation manager."""

from pathlib import Path

from clawpwn.config import get_project_db_path
from clawpwn.modules.session import SessionManager

from .models import ExploitResult
from .path_cmd_mixin import PathCommandMixin
from .sql_xss_mixin import SQLXSSMixin
from .utility_mixin import UtilityMixin


class ExploitManager(SQLXSSMixin, PathCommandMixin, UtilityMixin):
    """Manages exploitation operations."""

    def __init__(self, project_dir: Path | None = None):
        self.project_dir = project_dir
        self.session: SessionManager | None = None
        self.exploit_dir: Path | None = None

        if project_dir:
            self.exploit_dir = project_dir / "exploits"
            self.exploit_dir.mkdir(exist_ok=True)

            db_path = get_project_db_path(project_dir)
            if db_path and db_path.exists():
                self.session = SessionManager(db_path)


async def exploit_finding(
    target: str,
    finding_type: str,
    parameter: str,
    project_dir: Path | None = None,
) -> ExploitResult:
    """Quick exploit of a finding."""
    manager = ExploitManager(project_dir)
    return await manager.auto_exploit(target, finding_type, parameter)
